# 读书笔记

###### 阅读者：hauk0101

## 简介
书名：《Node与Express开发》 <br>
作者： Ethan Brown <br>
译者： 吴海星、苏文 <br>
出版发行：人民邮电出版社 <br>
出版时间：2015年2月

## 读后感

	终于读完了！这个是在看完最后几章之后的感触！
	
	在最后几章，感觉作者跟我一样着急，都是一个目标，赶紧完事！
	
	这本书对我的实践帮助其实并不太大，因为在阅读本书之前，本人其实已经开始进行 Node + Express 的实践开发了，因此书中的大部分内容对我来说可能只是起到了一点融会贯通的作用，并没有让我有太多醍醐灌顶的感受，不过或多或少也从中学到了不少知识，也算是在 Express 道路上的一小罐蜂蜜。

	文中很多地方并没有深入去剖析原理，个人觉得，如果是新手，完全不知从何下手的话，可以跟着书中的 Demo 去尝试，慢慢体会 Express 的用法，比较适合前端很熟练，但对后端无门道的朋友。
　　
## 总结
### 第1章 初识Express

这一章主要介绍了Javascript、NodeJS以及Express的一些简介，以及这几者之间的关系。
根据我的理解就是：
1. Node和Express都是基于Javascript语言进行开发和使用的，其中Node是Web服务器（同时也包含其相关的生态系统），类似于PHP、Ruby等语言和框架。
2. Express是基于Node的Web程序框架。
3. 其中Node和Express都可以正常的同数据库如MySQL、MongoDB等等进行操作和通信。

### 第2章 从Node开始

这一章主要是介绍了Node关于Web服务器相关的简单开发案例。
据我的理解就是：
1. Node + Node生态的其它模块也可以构建Web服务器。
2. npm是Node生态环境的相关包管理工具。
3. 向客户端返回一个"Hello World"输出、事件驱动编程介绍、路由介绍、静态资源服务等基本案例。

### 第3章 省时省力的Express

这一章主要介绍了如何安装Express框架，以及其自带的一些脚手架工具、工程文件目录等等。都是属于比较简单的说明，没有太复杂的代码。

### 第4章 工欲善其事，必先利其器

这一章主要说明了版本控制的重要性，同时推荐读者使用Git版本控制工具，并简单介绍了相关应用。

### 第5章 质量保证

这一章主要说明了QA的重要性，但并没有主要的使用方法，更多的是简要的说明了一下QA&测试对于整个项目的重要性，以及一些质量保证的步骤简单示例。因此只能作为一个了解的参考，并没有深入讲解。

### 第6章 请求和响应对象

在用Express构建Web服务器时，大部分工作都是从请求对象开始，到响应对象终止。

> URL的组成部分

|协议|主机名|端口|路径|查询字符串|信息片段|
|---|---|---|---|---|---|
|http://|localhost|:3000|/about|?test=1|#q=express|
|https://|google.com|:443(默认)|/..| ..|... |
|协议确定如何传输请求，主要处理http和https，常见的还有ftp,file|主机名识别服务器|每台服务器都有一些列端口号，其中80端口为http的默认端口，443为https的默认端口，自定义端口则需要大于1023|URL中影响应用程序的第一个组成部分通常是路径，路径是应用中的页面或其他资源的唯一标识|查询字符串是一种键值对集合，是可选的，它以?开头，以&分开，以=号作为键值对的连接符|大多是用于前端的“路由”功能|

### 第7章 Handlebars模板引擎

本章主要介绍了书中所使用的Express模板引擎，而由于我个人在实际项目中使用的ejs模板引擎，所以对此引擎暂时只是了解阶段，并没有太深入的研究学习。

> 不过文中介绍了使用JS模板引擎的情景，如下所示：

* 你必须不断地考虑哪些字符需要转义以及如何转义。
* 使用JavaScript来生成那些自身包含JavaScript代码的HTML会很快让你抓狂。
* 你通常会是去编辑器的语法高亮显示和其他方便的语言特性。
* 很难发现格式不正确的HTML。
* 很难直观地分析。
* 很难让别人读懂你的代码。

> 视图通常表现为网站上的各个页面，默认情况下，Express会在views子目录中查找视图。

### 第8章 表单处理

> 向服务器发送客户端数据

大体上讲，向服务器发送客户端数据有两种方式：查询字符串和请求正文。通常，如果是使用查询字符串，就发起了一个`GET`请求；如果是使用请求正文，就发起了一个`POST`请求。

_tips:_ `GET`和`POST`的请求方式和安全性关系都不大，如果想要保证传输数据的安全，应该使用`HTTPS`协议。

> HTML表单

对于服务器而言，表单最重要的属性是`<input>`域中的`name`属性。(之前在做文件上传时没有重视name的意义，算是趟过一个小坑)
_tips:_ 注意隐藏域：它不会呈现在浏览器中，但是，你不能使用它存放秘密和敏感信息；因为只要用户查看页面源文件，隐藏域就会暴露出来。

> 编码

不同内容对应的编码格式不同，如文本、文件、多媒体等等。

> 处理表单的不同方式

* 前端页面主要有两种提交表单的方式，一种是`ajax`，一种是`<form></form>`标签，但两者在使用时都需要标注提交的类型，即`GET`或者`POST`。
* express处理表单的方式，主要有：
	* 直接响应HTML，即直接向前端返回一个HTML，如果用户尝试重新加载页面，这种方法就会产生警告，并且会影响书签和后退按钮。
	* 302重定向，目前已被滥用，建议用303
	* 303重定向
	
* 对表单不同的处理方式是由于`<form></form>`提交表单之后会重新刷新页面，而`ajax`与它的区别在于可以异步与后台传输数据，不会重新刷新页面。因此，在前端选择表单提交时，应该考虑用户体验，做出最合适的选择。

_tips：_个人理解，对于express而言，在开发的时候可以考虑`<form></form>`表单的提交需要考虑如何在页面中继续跳转到其他页面的选择，而`ajax`表单提交更倾向于开发对应的接口进行数据交互。

> Express表单处理

* 如果使用`GET`进行表单提交，那么表单域在`req.query`对象中。
* 如果使用`POST`进行表单提交，则需要引入中间件`body-parser`, 之后表单域会出现在`req.body`中。
* 关于重定向
	* 301重定向是“永久”的，意味着浏览器会缓存重定向目标。如果使用301重定向并且视图第二次提交表单，浏览器会绕过整个重定向之前的逻辑，而直接进入重定向之后的页面，因为它正确地认为重定向是永久性的。
	* 303（或302）重定向则告诉浏览器，当前请求有效，可以在这里找到响应，并且不会缓存重定向目标。
	

> 处理Ajax表单

当仅为`GET`,`POST`两种请求时，可以视为`<form></form>`的相同处理方法，如果有其它类型的提交，可以根据情况再做详细处理。

> 文件上传

个人在开发时的一些见解：
* Express中文件上传可以借助其它中间件
* 文件上传时注意类型
* 文件上传时注意name，其实跟表单提交一样，因为之前犯过类似的错误

> jQuery文件上传

_tips：_ 再需要用的时候查看API或者参考网上实例即可，暂时没必要深究。


### 第9章 Cookie与会话

> Cookie 

* cookie对用户来说不是加密的。
* 用户可以删除或禁用cookie。
* 一般的cookie可以被篡改。
* cookie可以用于攻击。跨站脚本攻击（XSS）中有一种技术就涉及用恶意的JavaScript修改cookie中的内容。所以不要轻易相信返回到服务器的cookie内容。
* 应避免滥用cookie。
* 在做选择时，应先考虑会话（session）,再考虑cookie。
* 在使用cookie时，为了保证cookie的安全，应该必须有一个cookie秘钥，来配合客户端和服务器端cookie数据加密使用。

> Express 中的Cookie，可以使用中间件 cookie-parser

> 会话（Session）

* Express中，可以使用中间件 express-session
* 对于会话而言，我们不是用请求对象获取值，用相应对象设置值，它全部都是在请求对象上操作的。（相应对象上没有session属性）
* 删除会话，可以用JavaScript的delete操作符。

> 用会话实现即显消息

* flash的用法，区别于（Adobe Flash），它只会在前端响应一次，当再次刷新相同页面时，不会出现
* 可以找一个合适的flash相关的中间件



### 第10章 中间件

从概念上讲，中间件是一种功能的封装方式，具体来说就是封装在程序中处理HTTP请求的功能。从实战上讲，中间件只是一个有3个参数的函数：一个请求对象（req）、一个响应对象（res）和一个 next 函数。（还可能是4个参数，即包含 err 对象，用作错误处理）

> 中间件的顺序

* 中间件是在管道中执行的
* express 程序中，通过调用 app.use 向管道中插入中间件
* 中间件和路由处理器是按它们的连入顺序调用的，因此中间件的顺序很重要
* 中间件的终止，在中间件中不调用 next 方法，则中间件会停止，但应该发送一个响应到客户端，从而避免客户端被挂起而导致超时

> 中间件与路由处理器

* 路由处理器，包括 app.get 、app.post 等，经常被统称为 app.VERB ，可以被看作只处理特定 HTTP 谓词（GET、POST等）的中间件。同样，也可以将中间件看作可以处理全部 HTTP 谓词的路由处理器,基本上等同于 app.all，可以处理任何 HTTP 谓词；对于 PURGE 之类特别的谓词会有细微的差别，但对于普通的谓词而言，效果是一样的。
* 路由处理器和中间件的参数中都有回调函数，有2个、3个、4个参数的情况。如果是2个参数，则为 req 对象、res 对象；如果是3个参数，则为 req 对象、res 对象、next 对象；如果是4个参数，则为 err 对象、req 对象、res 对象、next 对象。
* 如果不调用 next()，管道就会被终止，也不会再有路由处理器或中间件做后续处理。（如果不调用 next() ，则应该发送一个响应到客户端（res.send、res.json、res.render等），从而避免客户端被挂起而导致超时）
* 如果调用了 next()，一般不宜再发送响应到客户端。如果发送了，管道中后续的中间件或路由器还会执行，但它们发送的任何响应都会被忽略。

> 常用的中间件

这部分介绍了一些常见的中间件，没有必要记录下来，在实际项目中如果有用到的话，可以针对相应的功能进行查找，一般来说 npm 上应该可以满足大部分要求，找不到之后，可以考虑自己造轮子。


### 第11章 发送邮件

本章个人认为比较有用的几点如下：

* 搭建邮件服务器时，尽量考虑使用第三方代理，以免自己的邮件服务器发送出去的邮件被收件人的邮件服务器认为是垃圾邮件
* Node和Express都没有内置的邮件发送功能，必须借助于第三方模块。文章推荐使用 Nodemailer
* 文章简单介绍了关于一个路由中调用两次res.render的用法。也就是说可以在以后的个别情况下考虑此用法。

### 第12章 与生产相关的问题

这一章讲的其实也比较粗略，可以认为是提供了一些思路。

* 配置不同的运行环境，开发环境、测试环境、生产环境等
* 以及两种拓展程序的方式，一种为在同一服务器上不同CPU中拓展服务，另一种为多服务器上的拓展方式，需要借助类似nginx代理服务器实现
* 处理服务器异常时，可以从node的两种机制入手去解决，分别是uncaughtException事件和域，作者更推荐从域的概念入手
* 压力测试，可以考虑使用node模块loadtest做一些简单的压力测试

### 第13章 持久化

这一章我的理解就是数据除了在内存中存取外，借助外部的存储空间来保证数据的存取。个人认为比较有用的点如下。

* 在保证某个目录是否存在时，如果不存在则创建的，比较优雅的写法：

```
//确保存在目录data
var dataDir = __dirname + '/data';
var vacationPhotoDir = dataDir + '/vacation-photo';
fs.existsSync(dataDir) || fs.mkdirSync(dataDir);
fs.existsSync(vacationPhotoDir) || fs.mkdirSync(vacationPhotoDir);
```

* 服务端在任何时候都不应该信任客户端传递过来的数据，即需要校验数据的安全性。
* 数据库持久化，noSQL的代表 MongoDB 文档数据库。
* node 在使用 MongoDB 数据库时，可以考虑使用 Mongoose 模块。
* 由于浮点数的特质，在 JavaScript 中涉及金融计算时要谨慎。在 ES6 中可以使用 decimal 类型来进行金融计算。
* 在从数据库取出数据后，应该做一些必要的数据格式化，而不是直接渲染到模板中（个人之前也一直会这样做）。
* 还有一个会话持久化的方案，即 Redis 。


### 第14章 路由

在未接触Express之前，其实对路由是没有概念的。甚至在使用路由的初期，自己对它还是不太理解，直到不断的使用，以及不断的查阅资料，再到现在查看文章中的路由相关的知识时，才发现实践和理论的结合还是很有意义的。

* 信息架构（IA），是指内容的概念性组织。实现持久的 IA 的一些建议：
	* 绝不在 URL 中暴露技术细节，如尽量不要出现类似 “.asp、.jsp”的后缀
	* 避免在 URL 中出现无意义的信息
	* 避免无谓的长 URL 
	* 单词分隔符要保持一致，尽量用连字符
	* 绝不要用空格或不可录入的字符，因为会被转义
	* 在 URL 中用小写字母
* 子域名相关，建议使用 vhost 包。
* 路由处理器是中间件。
* 路由冒号的用法，其实可以实现 REST API
* 关于组织路由，其实就是为了让路由更清晰、可维护、可拓展，其中个人在开发中使用过的讲 app 对象传入路由函数中的用法，也是可行的。


### 第15章 REST API 和 JSON

其实个人认为本章并没有什么特殊的内容，只是引入了 REST 风格的API接口的编写示例。更多的是如何实现这样的规范，包括如何借助一些第三方包。

其实在实际开发中还是需要看情况具体实现即可，并不一定要完全按照文章中说的来，所以个人认为本章并没有太多干货可言。

也可能是因为在实际开发中或多或少的有在使用这些内容吧，所以没有太多特别的感觉。同时也有可能是因为目前来说 API 的代码编写量还是太少，还没有遇到相关的瓶颈可言，所以对 REST API 没有太深的感触，对它的认识还处于一种写法级别的认知而已吧。

即使如此，REST API 还并未完全吃透，但是新的 API 写法又出来了，简单做个标记，目前比较火热的是 GraphQL 。

### 第16章 静态内容

其实本章内容讲的更多的是 Web 前端的性能优化相关的内容，更适合对前端了解不多的后端开发人员，因为这些内容对于前端开发人员是必须掌握的，也是经常遇见的。因此这章对我来说并没有太多的值得关注的知识点。

不过通章读完之后，还是发现有些地方是可以进行稍微整理的。比如：

在网站性能优化上，可以从减少请求次数、缩减内容大小两个方面去考虑。

* 减少请求次数：合并资源，浏览器缓存。
* 缩减内容大小：缩减静态资源本身的大小，如图片的大小、视频大小等等。

实现上述两种需求，其实还可以从打包js、css文件的角度出发，利用诸如gulp、grunt、webpack以及相关的第三方库的方式对源码进行混淆、压缩打包。

### 第17章 在 Express 中实现 MVC

本章所讲述的MVC概念，并没有出乎本人的意料，内容主要是总述了什么是 MVC ；然后分别讲解了M-V-C三个部分，并分别对应举出了例子，帮助我们更直观的了解。

* MVC 概念：
	* 模型即“Model”：是“纯粹”的数据和逻辑，它根本不关心自己与用户之间的交互。
	* 视图即“View”：是用来表现给用户的界面，将模型传递给用户。
	* 控制器即“Controller”：是接受用户输入，处理模型，选择要显示哪个或哪些视图。
* 我的理解：
	* M-模型：个人理解是通过一定的数据结构，封装一些为业务功能使用的数据模型，主要需要从数据库中查询出需要的数据，封装好之后再返回这个数据对象。
	* V-视图：最终呈现出来的界面，用于表现整个产品的业务功能和用户交互，而何时展示View 以及把什么内容展示出来则需要 Controller 的控制。
	* C-控制器：主要用来处理逻辑，即由项目的入口->逻辑判断 + 数据组装 -> 出口（View层）。
	* VM-视图模型（View-Model）:是对 model 层的进一步定制化封装，可以理解为某一个 View 层需要多个 model 的数据，为了便于拓展和可维护，再提出的一个 View-Model 的数据模型，专门来满足某个 View 的匹配。
* 每种语言都有类似 MVC 的框架，再不断实践，不断思考之后，会发现很多共通之处。理解了根本思想，能够很快分析或入手一个不熟悉的新项目。


### 第18章 安全

本章所讲述的内容，更多适用于简单了解一下，并没有太多可实际操作的意义。个人的感觉如下：

* 对安全部分而言，讲述了 https 服务、搭建 https 服务的注意事项，但并没有深入剖析 https 相关的原理性知识。
* 但是对于如何获取 https 服务倒是介绍了一些 CA 机构再购买相关 SSL 服务的策略，可以简单了解下。
* 对用户授权而言，讲的更多的是如何借助第三方授权的例子。而在实际开发中，涉及到第三方授权的应用，还需要结合实际项目以及相关第三方 API/SDK 的相关规范，如微博、QQ、微信等等。这方面的知识可以作为了解，而书中所属的并没有太多的实用价值。

### 第19章 集成第三方API

本章说实在的基本没有什么意义，就是抛出了一个集成第三方API的概念，讲的都是怎么嵌入Twitter、Facebook、Google地图等等；同时还需要考虑可能书中的代码在真实情况基本不能用，除去VPN的原因，还有第三方API自身的更新和升级，都会产生这样或那样的问题，所以在实际开发中，还是需要老老实实的阅读第三方API对应的文档。

如果非要说有什么价值，那就是我看到了作者把第三方集成API相关的代码放到了lib目录下。让我知道了原来lib可以放这些的。

### 第20章 调试

本章用文中的一句话表示：本章会讨论一些工具和技术。（然并卵）

### 第21章 正式启用

本章主要介绍了网站运维和部署的相关知识点，仅适合了解通读，无太多可操作价值。

### 第22章 维护

本章无干货，略。

### 第23章 其他资源

多说无益，更建议 www.google.com,不解释。
